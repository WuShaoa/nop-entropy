# XView View Model

## Functional Design

XView is a front-end interface description that is independent of the frontend framework and oriented toward the business domain. It expresses the core interaction logic of the front-end using a minimal set of concepts such as page (page), table (grid), form (form), and action (action). The final used front-end page `page.yaml` can leverage the `x:gen-extends` meta-programming mechanism to dynamically generate AMIS pages based on the XView model.

The XView model decomposes the construction of the front-end interface into field-level, form/table-level, and page-level.

1. `control.xlib`: Based on data type, domain, and edit mode, it infers the display control for a single field.
2. The `layout` model controls how the page is laid out, and in cases where field controls do not need to be changed, it can adjust the layout of the page.
3. Construction of the page can directly reference predefined forms and tables.

### Standard CRUD Page

Generally, the `xxx-web` module will execute a code generator located in the `precompile` directory when packaging with Maven, which is based on `xmeta` to generate front-end code. For example, in the `nop-auth-web/precompile/gen-page.xgen` file:

```xml
<c:script>
// Based on xmeta, generates page files such as view.xml and page.yaml
codeGenerator.withTplDir('/nop/templates/orm-web').execute("/", { moduleId: "nop/auth" }, $scope);
</c:script>
```

For example, based on the `NopAuthUser.xmeta` model, it generates the `_NopAuthUser.view.xml` file:
```xml
<view ...>
    <objMeta>/nop/auth/model/NopAuthUser/NopAuthUser.xmeta</objMeta>

    <controlLib>/nop/web/xlib/control.xlib</controlLib>

    <grids>
        <grid id="list" x:abstract="true">
            <cols>
                <!--用户名-->
                <col id="userName" mandatory="true" sortable="true"/>
                ..
                <!--生日-->
                <col id="birthday" sortable="true" x:abstract="true"/>
            </cols>
        </grid>
        <grid id="pick-list" x:prototype="list" x:abstract="true"/>
    </grids>

    <forms>
        <form id="view" editMode="view" title="查看-用户" i18n-en:title="View User">
            <layout>
                userName[用户名] nickName[昵称]
                deptId[部门] openId[用户外部标识]
                ...
            </layout>
        </form>
        <form id="add" editMode="add" title="新增-用户" i18n-en:title="Add User" x:prototype="edit"/>
        <form id="edit" editMode="update" title="编辑-用户" i18n-en:title="Edit User">
            <layout>...</layout>
        </form>
        <form id="query" editMode="query" title="查询条件" i18n-en:title="Query Condition" x:abstract="true">
            <layout/>
        </form>
        <form id="asideFilter" editMode="query" x:abstract="true" submitOnChange="true">
            <layout/>
        </form>
        <form id="batchUpdate" editMode="update" title="修改-用户" i18n-en:title="Update User">
            <layout/>
        </form>
    </forms>

    <pages>
        <crud name="main" grid="list" asideFilterForm="asideFilter" filterForm="query" x:abstract="true">
            ...
        </crud>
        <picker name="picker" grid="pick-list" asideFilterForm="asideFilter" filterForm="query" x:abstract="true">
            ...
        </picker>
        <simple name="add" form="add">
            <api url="@mutation:NopAuthUser__save/id"/>
        </simple>
        <simple name="view" form="view">
            <api url="@query:NopAuthUser__get/{@formSelection}?id=$id"/>
        </simple>
        <simple name="update" form="edit">
            <initApi url="@query:NopAuthUser__get/{@formSelection}?id=$id"/>
            <api url="@mutation:NopAuthUser__update/id?id=$id" withFormData="true"/>
        </simple>
    </pages>
</view>
# Abstract Handling in XUI Models

In many nodes generated by the xview model, the attribute `x:abstract="true"` is set. This indicates that the node is a virtual node and must be explicitly declared in derived models to retain its content. This design is similar to the `abstract` attribute in Spring Bean XML files, where `x:abstract` signifies that a node exists as a template.

1. **`objMeta`**  
   The `objMeta` indicates that the current xview model will use field configurations from the specified XMeta file.

2. **`controlLib`**  
   The `controlLib` defines how field types are mapped to specific UI components on the front end. Generally, no modification is needed for standard Web components. However, if you need to display different UI components for Mobile compared to standard ones, you can specify a separate control library.

3. **Default List and Pick-list Generation**  
   By default, a secondary table `list` and `pick-list` is generated. The `pick-list` uses the attribute `x:prototype="list"` to generate its structure based on sibling nodes of type `list`. This means that the appearance of the `pick-list` is the same as that of the `list`.

   In derived xview models, you can customize the `pick-list` by modifying its prototype.

4. **Add Form Behavior**  
   Similar to the relationship between `pick-list` and `list`, the `add` form inherits from the default `edit` form unless customized. The `editMode` property allows each form to have its own edit mode, ensuring that add, modify, select, and view operations can be handled by different UI components.

5. **Main Page Configuration**  
   The `main` page is configured with `filterForm="query"` and `asideFilterForm="asideFilter"`. This means that the query form is used as the main page's filter form. If you configure an `asideFilter` form, it will be displayed in the left sidebar of the main page to show a subset of query conditions.

---

# Table Configuration

For detailed configuration options, refer to the `[grid.xdef](https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-xdefs/src/main/resources/_vfs/nop/schema/xui/grid.xdef)` model definition.

---

## Grid Structure

### 1. Specifying Fields and Order

```xml
<grid id="list">
    <cols x:override="bounded-merge">
        <col id="fieldA"></col>
        <col id="fieldB"></col>
    </cols>
</grid>
```

Here, `x:override="bounded-merge"` ensures that the columns' scope is bounded within the current context. Any extra fields defined in inherited models will be automatically removed unless explicitly overridden.

---

### 2. Column Configuration

```xml
<col width="100px" align="right" id="fieldA" label="My Field"></col>
```

This configuration sets the column's width to 100 pixels, aligns its content to the right, assigns an ID of `fieldA`, and provides a display label.

---

### 3. Explicit Control

By default, table columns use the control specified by their type and the model's `editMode`. If you need a specific control for a column, you can explicitly define it using `[control.xlib](https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-web/src/main/resources/_vfs/nop/web/xlib/control.xlib)`.

For example:

```xml
<col id="fieldA">
    <gen-control>
        <c:script>
            return {
                'type': 'my-control'
            }
        </c:script>
    </gen-control>
</col>
```

---

# Form Layout

The layout DSL (`Domain Specific Language`) is defined in `[layout.md](layout.md)`. For form configuration, refer to the `[form.xdef](https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-xdefs/src/main/resources/_vfs/nop/schema/xui/form.xdef)` model.

---

# Common Functional Configurations

### 1. Sidebar for Filter Conditions
The sidebar can display filter conditions in a tree-like structure using `[tree.xdef](https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-xdefs/src/main/resources/_vfs/nop/schema/xui/tree.xdef)`. 

---

The form structure is defined in the `NopAuthUser.view.xml` file, where the left side contains a tree structure (`departmentTree`). When a department is clicked, it filters the user list on the right based on the selected department.

```xml
<form id="asideFilter" submitOnChange="true">
    <layout>
        ==dept[部门]==
        !deptId
    </layout>
    <cells>
        <cell id="deptId">
            <gen-control>
                <input-tree
                    source="@query:NopAuthDept__findList/value:id,label:deptName,children @TreeChildren(max:5)?filter_parentId=__null"/>
            </gen-control>
        </cell>
    </cells>
</form>
```

The `submitOnChange` attribute indicates that the form should submit a query when an item is clicked.


### 2. Nested Relationships in List Data
List data contains nested relationships, such as parent-child relationships in a department tree (`departmentTree`). The `@TreeChildren` directive allows for recursive fetching of up to 5 levels of data.

```yaml
url: "@query:NopAuthDept__findList/value:id,label:deptName,children @TreeChildren(max:5)?filter_parentId=__null"
```

This query fetches children recursively using the `@TreeChildren` directive, limiting the depth to 5 levels. The `filter_parentId=__null` parameter ensures that only root nodes are included.


### 3. Combining Multiple Existing Pages into a Composite Page
The composite page structure is defined in `NopAuthDept.view.xml`, where each tab corresponds to a specific functionality (e.g., `main` for the department tree and `list` for the user list).

```xml
<tabs name="tabsView" tabsMode="vertical" mountOnEnter="true" unmountOnExit="true">
    <tab name="main" page="main" title="@i18n:common.treeView"/>
    <tab name="list" page="list" title="@i18n:common.listView"/>
</tabs>
```


### 4. Adding Multiple Query Conditions to a List Page
To add multiple query conditions to a list page, refer to the `NopAuthUser.view.xml` file. New fields can be added directly in the form (`id="query"`).

```xml
<form id="query">
    <layout>
        userName gender nickName phone status
    </layout>
</form>

<pages>
    <crud filterForm="query" ... >
    </pages>
```

By default, all fields use an equality condition. Custom conditions can be defined in `NopAuthUser.xmeta` to specify query operators like `eq`, `contains`, and `like`.

```xml
<prop name="userName" allowFilterOp="eq,contains" xui:defaultFilterOp="contains"/>
```


### 5. Hiding Row Actions
The row actions are hidden by default in the list view.

### English Translation of Technical Document

#### 1. Add a Page
Add a page similar to the default CRUD page, but with different query conditions.

```xml
<crud name="xxx">
    <table noOperations="true" />
</crud>
```

---

### 6. Add a Page
Add a page similar to the default CRUD page, but with different query conditions.

```xml
<crud name="list" grid="list" x:prototype="main">
    <table x:prototype-override="replace">
        <api url="@query:NopAuthDept__findPage/{@pageSelection}"/>
    </table>
</crud>
```

* `x:prototype` indicates inheritance from the sibling node.
* `x:prototype-override=replace` indicates overriding of the table node, merging instead of completely replacing in the default case.

---

### 7. Button Click
Click a button to pop up a dialog box. After filling out, perform backend operations, close the dialog box, and refresh the original page.

See [LitemallGoods.view.xml](https://gitee.com/canonical-entropy/nop-app-mall/blob/master/app-mall-web/src/main/resources/_vfs/app/mall/pages/LitemallGoods/LitemallGoods.view.xml)

---

### 8. Submit Form
Click a button to pop up a dialog box. After filling out, perform backend operations, close the dialog box, and refresh the original page.

```xml
<crud name="role-users" grid="simple-list">
    <listActions>
        <action id="select-user-button" label="@i18n:common.selectUser">
            <dialog page="select-role-users" size="md" noActions="true">
                </dialog>
            </action>
        </listActions>
    </crud>

<crud name="select-role-users" grid="pick-list" title="@i18n:common.selectUser">
    <listActions>
        <action id="batch-add-user-button" label="@i18n:common.submit" level="primary"
                batch="true" close="select-role-users" reload="role-users-grid">
            <api url="@mutation:NopAuthRole__addRoleUsers">
                <data>
                    <roleId>$roleId</roleId>
                    <userIds>$ids</userIds>
                </data>
            </api>
        </action>
    </listActions>
</crud>
```

* In `action` configuration, if `dialog` child node exists, it will display a dialog box.
* The `page` attribute in `dialog` can directly reference the defined page. If the full path is used, it refers to an external definition. If the `page` name is provided, it refers to the current XView model's definition.
* The `noActions="true"` in `dialog` indicates that built-in submit and cancel buttons should not be used.
* In `action`, `batch="true"` indicates that this action handles batch selections. `close` indicates closing the window after the operation is performed. `reload` indicates reloading the specified grid, such as the `role-users` table.

---

### 8. Submit Form
Submit form data along with the main table data.

```markdown
# Adding a View Configuration for Subtable Property

```xml
<form id="edit">
<cells>
  <cell id="products">
    <!-- Reference an external view model's grid to display sub-table -->
    <view path="/app/mall/pages/LitemallGoodsProduct/LitemallGoodsProduct.view.xml" 
          grid="ref-edit"/>
  </cell>
</cells>
</form>
```

Add a view configuration for the subtable property. This allows you to specify which table should be edited in the subtable. The XView model will automatically analyze the view configuration and retrieve the table fields, merging them into the current form's corresponding GraphQL query.

---

### Customizing Buttons on List Rows

```xml
<crud name="main">
<!-- Bounded-merge indicates that results are merged within the current model scope. Fields present in the base model but not in the current model will be automatically deleted. -->
  <!-- Default generated code already includes row-update-button and row-delete-button, with x:abstract="true set. -->
  <!-- Therefore, you only need to declare the ID to enable inheritance of buttons, avoiding duplicate code. -->
  
  <rowActions x:override="bounded-merge">
    <action id="row-update-button" actionType="drawer"/>
    
    <action id="row-delete-button"/>
  </rowActions>
</crud>
```

---

### Displaying Form Data Excessively

```xml
<form id="view" layoutControl="tabs">...</form>
```

Configure `layoutControl="tabs"` to display form data in tabbed sections.

---

### Opening Related Subtable Edit Page

```xml
<action id="row-edit-rule-nodes" label="@i18n:rule.ruleNodes|Rules Nodes" actionType="drawer">
  <dialog page="/nop/rule/pages/NopRuleNode/ref-ruleDefinition.page.yaml" size="xl">
    <data>
      <ruleId>$ruleId</ruleId>
      <ruleDefinition>
        <displayName>$displayName</displayName>
      </ruleDefinition>
    </data>
  </dialog>
</action>
```

When the row button is clicked, a dialog opens to edit related rule nodes. The `data` section specifies which fields should have fixed values during the dialog.

---

### Fixed Props in Dialog

```yaml
x:gen-extends: |
  <web:GenPage view="NopRuleNode.view.xml" page="main" fixedProps="ruleId" xpl:lib="/nop/web/xlib/web.xlib"/>
```

This configuration ensures that specific fields (e.g., `ruleId`) are set to fixed values in the dialog, preventing users from editing them.

---

### Displaying Recursive Data Structure with Combo

```xml
<cell id="ruleInputs">
  <gen-control>
    return { "$ref": "viewInputDefinition" }
  </gen-control>
</cell>
```

In the `page.yaml` file, include the `definitions` section to reference nested structures, ensuring that combo components display recursive data accurately.

```yaml
x:gen-extends: |
    <web:GenPage view="NopRuleDefinition.view.xml" page="main" xpl:lib="/nop/web/xlib/web.xlib" />

definitions:
    "x:extends": "var-definitions.json5"
```


### 13. Add a field that is only used in the frontend, not submitted to the backend

`custom="true"` indicates this field does not need to be defined in meta. Two underscores as a prefix indicate this field is only used in the frontend and will not be submitted to the backend.

```xml
<cell id="__useImportFile" label="导入模型文件" custom="true" stdDomain="boolean">
</cell>
```


### 14. Specify query conditions and sorting criteria via URL

```xml
<api url="@query:NopAuthUser__findList?filter_userStatus=1&amp;orderField=userName&amp;orderDir=asc" />
```

Sorting conditions can be represented by `orderField={fieldName}&orderDir={asc|desc}` or passed as an Array.


## Problem Handling


### 1. AJAX call on CRUD buttons may not trigger table reload

```xml
<crud name="main">
    <rowActions>
        <action id="test_ajax" level="primary" label="nop test ajax"
                actionType="ajax" reload="none">
            <api url="@query:NopAuthDept__get?id=$id" gql:selection="managerId"/>
        </action>
    </rowActions>
</crud>
```

`reload="none"` can be set to disable this feature.


### 2. Passing parameters to referenced child pages

```xml
<form id="rowView" editMode="view" title="查看合同" size="lg">
    <layout>
        !@contractId
    </layout>
    <cells>
        <cell id="contractId">
            <view path="/app/demo/pages/ContractMain/detail.page.yaml" />
        </cell>
    </cells>
    <data>
        <id>$contractId</id>
    </data>
</form>
```

* The child page (AMIS) can directly access the parent's variables via `$scope.parent contratoId`. Setting form data will cause each form control to display the corresponding variable.

Additionally, it can be implemented by customizing the view:

```xml
<cell id="contractId">
    <view path="/app/demo/pages/ContractMain/ContractMain.view.xml" page="viewContract"/>
</cell>
```

* In the specified `view.xml` model file, add a `page` definition and utilize Delta customization to inherit existing pages and customize `initApi` settings. This is on the XView model level.

Also, it can be implemented by importing `page.yaml` and inheriting existing `page.yaml` in the `page.yaml`, making adjustments on the AMIS layer.


## default-query configuration

If `meta` has a `default-query` label, it will automatically collect all fields where `visible and !internal and queriable and ui:show` into the query form.

Using the AMIS `autoGenerateFilter` mechanism to achieve frontend query forms.

