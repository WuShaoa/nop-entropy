<task x:schema="/nop/schema/task/task.xdef" xmlns:x="/nop/schema/xdsl.xdef"
      x:extends="/nop/task/lib/common.task.xml,/nop/task/lib/batch-base.task.xml"
      xmlns:batch="/nop/batch/xlib/batch.xlib" xmlns:record="record" x:dump="true">

    <input name="bizDate" type="LocalDate" />

    <record:file-model name="SimpleFile" binary="true">
        <body>
            <fields>
                <field name="name" type="String" length="10" padding=" "/>
                <field name="product" type="String" length="5" padding=" "/>
                <field name="price" type="double" codec="f8be"/>
                <field name="quantity" type="int" codec="u8be"/>
            </fields>
        </body>
    </record:file-model>

    <steps>
        <custom name="test" customType="batch:Execute" useParentScope="true">
            <batch:task batchSize="100">
                <loader>
                    <file-reader filePath="/data/input/${bizDate}.dat" record:file-model="SimpleFile" />
                </loader>

                <processor>
                    <source>
                        consume(item);
                    </source>
                </processor>

                <consumer name="all">
                    <file-writer filePath="/data/output/${bizDate}-all.dat" record:file-model="SimpleFile"/>
                </consumer>

                <consumer name="selected">
                    <filter>
                        return item.quantity > 100;
                    </filter>

                    <file-writer filePath="/data/output/${bizDate}-selected.dat" record:file-model="SimpleFile"/>
                </consumer>

            </batch:task>
        </custom>
    </steps>
</task>